<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../file-upload/file-upload.html">
<link rel="import" href="../paper-chip/paper-chip.html">
<!--
  `<q-card></q-card>` d
  @demo demo.html
-->

<dom-module id="q-card">
  <template>
    <template is="dom-repeat" items="{{files}}">
      <paper-chip style="max-width: 32%" title="[[item.url]]" on-tap="addurl" title="[[item.url]]" >
        <template is="dom-if" if="[[item.image]]">
          <div slot="icon" class="icon" title="[[item.url]]"> 
            <img src="[[item.image]]" style="min-width:32px;height:32px" />
          </div>
        </template>
        <div slot="label" title="[[item.url]]" class="label"> [[item.name]] </div>
      </paper-chip>
    </template>
    <file-upload files="{{files}}" meta="[[meta]]" accept="[[accept]]"></file-upload>
  </template>
</dom-module>

<script>
  Polymer({
    is: "q-card",
    properties:{
      card:{
        notify: true,
      },
      chips:{
        notify: true,
        type: Array,
        value: [],
      },
      meta: {
        value: {},
        type: Object,
      },
      part: {
        value: 0
      },
      prompt:{
        type: String,
        notify: true,
      },
      _setPrompt: {
        computed:"setPrompt(line, card, part)",
      },
      cardTricks:{
        value: [
          {
            chip: "add signature",
          },
          {
            chip: "add image ",
            intent: "^(?:add|with) image ((?:https?|data):(?:\/\/)?.*(?:\.|\/){1}(?:png|jpeg|jpg|gif).*)",
            prompt: "add url",
            accept: "image/*",
            action: [
              {insert: "\n"},
              {insert: {image: '$1'}},
              {insert: "\n"},
            ],
          },
          {
            chip: "add list ",
            prompt: "Start Your list",
            intent: "^(?:add|in a) list (.+)*",
            action: [
              {insert: "\n"},
              { 
                attributes: {
                  list: "bullet"
                },
                insert: "$1\n",
              },
            ],
            split: "\\s?,\\s?",
          },
          {
            chip: "add Heading ",
            prompt: "Type the Heading",
            intent: "^(?:add|in a|as a) heading (.+)$",
            action: [
              {insert: "\n"},
              {
                attributes: {
                  header: 2
                },
                insert: "$1\n",
              },
            ],
          },
        ]
      }
    },
    chip: function(line){
      console.log(line)
    },
    setPrompt: function(line, card, part) {
      if (part || this.editor && this.editor.getContents() && this.editor.getContents().length < 3) {
        this.chips = []
        this.prompt = ""
        return
      }
      var chips = {}
      this.prompt = ""
      if (this.editor && this.editor.getSelection() && this.editor.getSelection().index) {
        line = this.editor.getLine(this.editor.getSelection().index)[0].domNode.outerText
      }
      for (var index = 0; index < this.cardTricks.length; ++index) {
        var chip = this.cardTricks[index].chip
        if (chip == line) {
          var prompt = this.cardTricks[index].prompt
          if (prompt) {
            this.prompt = prompt
          }
          if (this.prompt == "add url") {
            this.addUrl = true
            if (chip.accept) {
              this.accept = chip.accept
            }
          } else {
            this.accept = "*"
            this.addUrl = false
          } 
        } else if (chip.toLowerCase().startsWith(line) && line) {
          chips[chip] = true // chips for autocomplete if the lying can be replaced while you were typing
        }
      }

      this.debounce("update", this.getPrompt,2000)
      if (!part) {
        this.set("chips", Object.keys(chips))
      }
    },
    getPrompt: function(){
      if (this.part || this.editor && this.editor.getContents() && this.editor.getContents().length < 3) {
        this.chips = []
        this.prompt = ""
        return
      } // TODO DRY
      var line = ""
      if (this.editor && this.editor.getSelection() && this.editor.getSelection().index) {
        line = this.editor.getLine(this.editor.getSelection().index)[0].domNode.outerText
      }
      var card = this.card
      var chips = {}
      for (var index = 0; index < this.cardTricks.length; ++index) {
        var chip = this.cardTricks[index].chip
        if (chip == line) {
          var prompt = this.cardTricks[index].prompt
          if (prompt) {
            this.chips = []
            this.prompt = prompt
          }
          return 
        }
        chips[chip] = this.cardTricks[index]
      }
      if (card && this.editor && this.editor.getSelection()) {
        if(!card.title || card.title.length < 3) {
          this.prompt = "Name it (more)"
        } else if(!line) {
          this.prompt = "Add some text"
        } else {
          this.prompt = ""
        }
      } else {
        this.prompt = "Name it"
        chips = {}
      }

      if (this.part) {
        this.chips = []
      } else {
        var that = this
        this.chips = Object.keys(chips).filter(function(chip) {
          if (chips[chip].intent) {
            console.log(that.line)
          } else {
            return true
          }
        }).map(function(chip) {
          return {
            text: chip,
            onTap: function() {
              var ops = that.editor.getContents().ops
              var action = chips[chip].action
              if (that.editor.getSelection() !== null) {
                var cur = that.editor.getSelection().index + 1
                if (action) {
                  var regex = new RegExp(chips[chip].intent, "i")
                  // select Line
                  if (!chips[chip].split) {
                    action = JSON.parse(
                      line.replace(regex, JSON.stringify(action)).replace(/(\n|\t)/gm,"\\n")
                    )
                  } else {
                    action = JSON.parse(
                      line.replace(new RegExp(chips[chip].split, "gm"), "\\n").replace(regex, JSON.stringify(action)).replace(/(\n|\t)/gm,"\\n")
                    )
                  }
                  that.editor.updateContents([{retain:(cur - (line.length+1))},{delete:line.length+1}] // Keep to cur
                     .concat(action)
                  )
                  that.editor.setSelection(that.quill.getLength(), 0)
                  that.editor.focus()
                } else {
                  that.editor.insertText(cur, chip)
                }
              } else {
                if (action) {
                  that.editor.setContents(ops.concat(action))
                } else {
                  that.editor.setContents(ops.concat([{insert: chip + "\n"}]))
                }
              }
              console.log("chip", chips[chip])
            },
          }
        })
      }
    },
    ready: function() {
      this.getPrompt()
    },
    addurl: function(e) {
      this.editor.focus()
      if (e.target.title) {
        console.log(this.editor.savedRange)
        var cur = this.editor.getSelection().index
        var line = this.editor.getLine(cur)[0].domNode.outerText.replace("\n","").trim()
        this.editor.deleteText(cur - line.length, line.length)
        
        this.editor.insertEmbed(this.editor.getSelection().index, 'image', e.target.title)
      }
    },
  })
</script>
