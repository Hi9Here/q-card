<link rel="import" href="../polymer/polymer.html">
<!--
  `<q-card></q-card>` d
  @demo demo.html
-->
<script>
  Polymer({
    is: "q-card",
    properties:{
      card:{
        notify:true,
      },
      chips:{
        notify:true,
        type:Array,
      },
      prompt:{
        type:String,
        notify:true,
      },
      _setPrompt: {
        computed:"setPrompt(line, card)",
      },
      cardTricks:{
        value: [
          {
            chip: "add image ",
            intent: "^(?:add|with) image (.+)",
            prompt: "add for url ",
            action: [
              {insert: "\n"},
              {insert: {image: '$1'}},
              {insert: "\n"},
            ],
          },
          {
            chip: "add list ",
            prompt: "Start Your list",
            intent: "^(?:add|in a) list (.+)*",
            action: [
              {insert: "\n"},
              { 
                attributes: {
                  list: "bullet"
                },
                insert: "$1\n",
              },
            ],
            split: "\\s?,\\s?",
          },
          {
            chip: "add Heading ",
            prompt: "Type the Heading",
            intent: "^(?:add|in a|as a) (?:heading|title) (.+)$",
            action: [
              {insert: "\n"},
              { 
                attributes: {
                  header: 2
                },
                insert: "$1\n",
              },
            ],
          },
        ]
      }
    },
    chip: function(line){
      console.log(line)
    },
    setPrompt: function(line, card) {
      this.chips = []
      this.prompt = ""
      for (var index = 0; index < this.cardTricks.length; ++index) {
        var chip = this.cardTricks[index].chip
        if (chip == line) {
          var prompt = this.cardTricks[index].prompt
          if (prompt) {
            this.prompt = prompt
          }
        }
      }
      this.debounce("update", this.getPrompt,2000)
    },
    getPrompt: function(){
      var line = ""
      if (this.editor.getSelection() && this.editor.getSelection().index) {
        line = this.editor.getLine(this.editor.getSelection().index)[0].domNode.outerText
      }
      var card = this.card
      var chips = []
      for (var index = 0; index < this.cardTricks.length; ++index) {
        var chip = this.cardTricks[index].chip
        if (chip == line) {
          var prompt = this.cardTricks[index].prompt
          if (prompt) {
            this.chips = []
            this.prompt = prompt
          }
          return 
        }
        chips.push(chip)
      }
      if (card) {
        if(!card.name || card.name.length < 3) {
          this.prompt = "Name it (more)"
        } else if(!card.image) {
          if (this.editor) {
            var cur = this.editor.getSelection().index+1
            this.editor.insertEmbed(cur, 'image', '/deko-150.png')
            this.editor.insertText(cur+1, "\n")
            this.editor.setSelection(cur+2)
            this.card.image = '/deko-150.png'
          }
        } else if(!line) {
          chips.push("Done")
          this.prompt = "Add some text"
        } else {
          this.prompt = ""
        }
      } else {
        this.prompt = "Name it"
      }
      if (line && this.cardTricks.length) {
        for (var trick = 0; trick < this.cardTricks.length; ++trick) {
          var regex = new RegExp(this.cardTricks[trick].intent, "i")
          var matchs
          if ((matchs = regex.exec(line)) !== null) {
            var cur = this.editor.getSelection().index+1 
            var action = this.cardTricks[trick].action
            // select Line
            if (!this.cardTricks[trick].split) {
              action = JSON.parse(
                line.replace(regex, JSON.stringify(this.cardTricks[trick].action)).replace(/(\n|\t)/gm,"\\n")
              )
            } else {
              action = JSON.parse(
                line.replace(new RegExp(this.cardTricks[trick].split, "gm"), "\\n").replace(regex, JSON.stringify(this.cardTricks[trick].action)).replace(/(\n|\t)/gm,"\\n")
              )
            }
            this.editor.updateContents([{retain:(cur - (line.length+1))},{delete:line.length+1}] // Keep to cur
              .concat(action)
            )
          }
        }
      }
      
      this.chips = chips
    },
    ready: function() {
      this.getPrompt()
    },
  })
</script>
